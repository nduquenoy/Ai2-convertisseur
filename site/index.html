<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertisseur AIA vers Android Studio</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 50px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); }
        h1 { color: #00796b; text-align: center; margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #004d40; }
        input[type="file"], input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background-color: #00796b; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #004d40; }
        #log-output { background-color: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; border-radius: 8px; white-space: pre-wrap; margin-top: 20px; min-height: 100px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Convertisseur AIA ‚û°Ô∏è Android Studio (Kotlin)</h1>

    <div class="input-group">
        <label for="aiaFile">1. Choisir le Fichier AIA (.aia)</label>
        <input type="file" id="aiaFile" accept=".aia" required>
        <small>Un fichier .aia est une archive .zip contenant la source de votre projet.</small>
    </div>

    <div class="input-group">
        <label for="projectName">2. Nom du Projet Android Studio</label>
        <input type="text" id="projectName" value="MonProjetKotlin" required>
    </div>

    <button onclick="startConversion()">Convertir et Simuler la G√©n√©ration üöÄ</button>

    <div id="log-output">
        Statut de la conversion : Pr√™t.
    </div>
</div>

<script>
/**
 * NOTE TECHNIQUE :
 * Pour une vraie conversion, le code ci-dessous (la fonction startConversion)
 * devrait envoyer le fichier AIA √† un serveur (back-end) pour un traitement lourd :
 * 1. D√©compression du ZIP (AIA).
 * 2. Parsing du fichier .scm (Layout).
 * 3. Parsing du fichier .bky (Blocs XML).
 * 4. Transpilation des blocs en Kotlin.
 * 5. Cr√©ation de la structure Android Studio (XML, Kotlin, Gradle, Assets).
 * 6. Compression en fichier ZIP final.
 *
 * Le script ci-dessous SIMULE ces √©tapes pour illustrer la maquette frontale.
 */
function startConversion() {
    const fileInput = document.getElementById('aiaFile');
    const projectName = document.getElementById('projectName').value.trim() || 'ConvertedApp';
    const logOutput = document.getElementById('log-output');
    const file = fileInput.files[0];

    logOutput.textContent = 'Statut de la conversion : D√©marrage...';

    if (!file) {
        logOutput.textContent += '\nERREUR : Veuillez s√©lectionner un fichier .aia.';
        return;
    }

    logOutput.textContent = `Statut de la conversion : Lecture de "${file.name}" et encodage en Base64...`;

    // Utilisation de FileReader pour lire le contenu du fichier
    const reader = new FileReader();

    reader.onload = async function(event) {
        // Le r√©sultat est le contenu du fichier encod√© en Base64 (apr√®s le pr√©fixe)
        const base64Aia = event.target.result.split(',')[1];
        
        logOutput.textContent += '\n[OK] Fichier encod√©. Envoi √† la fonction Netlify...';
        
        try {
            // --- Appel √† la fonction Netlify ---
            const response = await fetch('/.netlify/functions/convert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file: base64Aia, // Le contenu Base64 du fichier AIA
                    projectName: projectName
                }),
            });
            // ------------------------------------

            if (!response.ok) {
                // Tente de lire le message d'erreur du backend
                const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue du serveur.' }));
                throw new Error(`Erreur Netlify Function : ${errorData.error || response.statusText}`);
            }

            // Si la conversion r√©ussit (statut 200)
            logOutput.textContent += '\n‚úÖ CONVERSION TERMIN√âE ! Le fichier ZIP est g√©n√©r√©.';
            
            // --- D√©clenchement du t√©l√©chargement ---
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName}.zip`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            // ------------------------------------

        } catch (error) {
            logOutput.textContent += `\n‚ùå √âCHEC DE LA CONVERSION : ${error.message}`;
            console.error(error);
        }
    };

    // Lecture du fichier comme une URL de donn√©es (Base64)
    reader.readAsDataURL(file);
}
</script>

</body>
</html>
